name: CI (Ant, PHP 7.3, V2)

on:
  push:
    tags-ignore:
      - '**'
    branches:
      - '**'
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'examples/**'
  pull_request:
    tags-ignore:
      - '**'
    branches:
      - '**'
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'examples/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Setup PHP with PECL extension
      uses: shivammathur/setup-php@v2
      with:
        php-version: '7.3'
        extensions: imagick, swoole
        coverage: xdebug
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'adopt'
    - name: Validate composer.json and composer.lock
      run: composer validate --strict
    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress
    - name: Run Tests
      run: |
        set +e
        ./vendor/bin/phpunit --configuration ./build/phpunit.xml
        exitcode="$?"
        echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
        exit "$exitcode"
    - name: Run Validation
      run: |
        set +e
        mkdir ./build/validator
        wget https://github.com/itplr-kosit/validator/releases/download/v1.5.0/validator-1.5.0-distribution.zip -O ./build/validator/validator.zip
        wget https://github.com/itplr-kosit/validator-configuration-xrechnung/releases/download/release-2023-07-31/validator-configuration-xrechnung_3.0.0_2023-07-31.zip -O ./build/validator/validator-configuration.zip
        unzip ./build/validator/validator.zip -d ./build/validator
        unzip ./build/validator/validator-configuration.zip -d ./build/validator
        php -f ./examples/XRechnung3SimpleQuick.php
        java -jar ./build/validator/validationtool-1.5.0-standalone.jar -r ./build/validator -s ./build/validator/scenarios.xml ./examples/factur-x.xml
        exitcode="$?"
        echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
        exit "$exitcode"
      